<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∞—Å–∏ –ë–µ–π–∫–æ–Ω–∞! ü•ì</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    <div class="container">
        <h1>–°–ø–∞—Å–∏ –ë–µ–π–∫–æ–Ω–∞! ü•ì</h1>
        <img src="{{ url_for('static', filename='bacon.png') }}" class="bacon-img" id="baconImg">
        <div class="counter">
            –í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: <span id="totalClicks">0</span>/777,777
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <button class="click-button" id="clickButton">–ö–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã —Å–ø–∞—Å—Ç–∏!</button>
    </div>

    <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
    <audio id="clickSound" src="{{ url_for('static', filename='click.mp3') }}"></audio>
    <audio id="winSound" src="{{ url_for('static', filename='win.mp3') }}"></audio>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const MAX_CLICKS = 777777;
        const CLICK_DELAY = 100; // 100ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        let isCelebrating = false;
        let clickQueue = 0;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const elements = {
            clickButton: document.getElementById('clickButton'),
            totalClicks: document.getElementById('totalClicks'),
            progressBar: document.getElementById('progressBar'),
            baconImg: document.getElementById('baconImg'),
            clickSound: document.getElementById('clickSound'),
            winSound: document.getElementById('winSound')
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
        function handleClick() {
            if (isCelebrating) return;
            
            clickQueue++;
            elements.clickSound.currentTime = 0;
            elements.clickSound.play();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
            elements.clickButton.classList.add('clicked');
            setTimeout(() => {
                elements.clickButton.classList.remove('clicked');
            }, 100);
            
            // –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏
            if (clickQueue === 1) processQueue();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–ª–∏–∫–æ–≤
        async function processQueue() {
            while (clickQueue > 0) {
                await sendClickRequest();
                clickQueue--;
                await new Promise(resolve => setTimeout(resolve, CLICK_DELAY));
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendClickRequest() {
            try {
                const response = await fetch('/add_click', { method: 'POST' });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                updateUI(data);
                if (data.maxReached) startCelebration();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI(data) {
            elements.totalClicks.textContent = data.total.toLocaleString();
            const progress = (data.total / MAX_CLICKS * 100).toFixed(2);
            elements.progressBar.style.width = `${progress}%`;
            elements.progressBar.textContent = `${progress}%`;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –±–µ–∫–æ–Ω—á–∏–∫–∞
            elements.baconImg.style.transform = `scale(${1 + data.total/MAX_CLICKS*0.5})`;
        }

        // –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        function startCelebration() {
            if (isCelebrating) return;
            isCelebrating = true;
            
            // –ó–≤—É–∫ –ø–æ–±–µ–¥—ã
            elements.winSound.play();
            
            // CSS-–∞–Ω–∏–º–∞—Ü–∏–∏
            document.body.classList.add('celebrate');
            elements.baconImg.classList.add('animate__tada');
            
            // –ö–æ–Ω—Ñ–µ—Ç—Ç–∏
            for(let i = 0; i < 200; i++) {
                createConfetti();
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
            confetti.style.animation = `
                fall ${Math.random() * 3 + 2}s linear,
                drift ${Math.random() * 2 + 1}s ease-in-out infinite
            `;
            
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadInitialData() {
            try {
                const response = await fetch('/get_clicks');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        elements.clickButton.addEventListener('click', handleClick);
        loadInitialData();
    </script>
</body>
</html>
