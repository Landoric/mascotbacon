<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Спаси Бейкона! </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    <div class="container">
        <h1>Спаси Бейкона! </h1>
        <img src="{{ url_for('static', filename='bacon.png') }}" class="bacon-img" id="bacon">
        <div class="counter">
            Всего кликов: <span id="total">0</span>/777,777
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progress" style="width: 0%">0%</div>
        </div>
        <button class="click-btn" id="clickBtn">Кликни!</button>
    </div>

    <audio id="clickSound" src="{{ url_for('static', filename='click.mp3') }}"></audio>
    <audio id="winSound" src="{{ url_for('static', filename='win.mp3') }}"></audio>

    <script>
        const MAX = 777777;
        let isCelebrating = false;

        const elements = {
            clickBtn: document.getElementById('clickBtn'),
            total: document.getElementById('total'),
            progress: document.getElementById('progress'),
            bacon: document.getElementById('bacon'),
            clickSound: document.getElementById('clickSound'),
            winSound: document.getElementById('winSound')
        };

        async function addClick() {
            if (isCelebrating) return;
            
            elements.clickBtn.disabled = true;
            elements.clickSound.currentTime = 0;
            elements.clickSound.play();
            
            try {
                const response = await fetch('/add_click', { method: 'POST' });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                updateUI(data);
                if (data.maxReached) celebrate();
            } catch (error) {
                console.error('Ошибка:', error);
            } finally {
                elements.clickBtn.disabled = false;
            }
        }

        function updateUI(data) {
            // Добавлена проверка на существование данных
            if (!data || typeof data.total === 'undefined') {
                console.error('Получены некорректные данные:', data);
                return;
            }

            elements.total.textContent = data.total.toLocaleString();
            const percent = (data.total / MAX * 100).toFixed(2);
            elements.progress.style.width = `${percent}%`;
            elements.progress.textContent = `${percent}%`;
            
            if (data.total >= MAX) celebrate();
        }

        function celebrate() {
            if (isCelebrating) return;
            isCelebrating = true;
            
            document.body.classList.add('victory');
            elements.winSound.play();
            
            for (let i = 0; i < 200; i++) {
                createConfetti();
            }
            
            elements.bacon.classList.add('animate__animated', 'animate__heartBeat');
            elements.clickBtn.disabled = true;
        }

        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animation = `
                fall ${Math.random() * 3 + 2}s linear,
                drift ${Math.random() * 2 + 1}s ease-in-out infinite
            `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }

        // Инициализация с обработкой ошибок
        async function init() {
            try {
                const response = await fetch('/get_clicks');
                if (!response.ok) throw new Error('Ошибка сети');
                
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                elements.total.textContent = '0';
            }
        }

        elements.clickBtn.addEventListener('click', addClick);
        init(); // Запуск инициализации
    </script>
</body>
</html>
